## 交易的生命周期
我们的交易进入是fcfs还是以priority fee来排序呢？这直接影响了代币经济学，因此我们先研究以太坊的[代币经济学](/docs/research/tokennomics.md)。
在这里，我们了解到了以太坊的经济模型设计，主要是矿工和用户之间的博弈而导致的结果，设计了EIP-1559。我也沿用以太坊的经济模型，我们也还是比较认可这一套方案。

首先需要认识到全节点与轻节点的差异，我们推荐读者阅读该[文章](https://ethereum.org/zh/developers/docs/nodes-and-clients/)。  

首先，交易是通过全节点发送的，也就是用户得从全节点发送交易，全节点公开一个接口RPC，来为第三方钱包提供服务，用户与钱包交互，轻量级钱包使用第三方RPC，也就是某个服务器运行的全节点，来间接发送交易。当全节点向网络广播交易时，需要全节点构建一笔符合要求的交易，其格式在README.md，当然也可以通过客户端构建+用户签名，然后全节点验证有效性，再进行广播。
1. 交易哈希以加密方式生成
2. 然后，该交易被广播到网络并添加到由所有其他待处理网络交易组成的交易池中
3. 验证者必须选择您的交易并将其包含在一个块中，以便验证该交易并认为它“成功”
4. 随着时间的推移，包含您交易的区块将升级为“合理”，然后“最终确定”。这些升级使得用户更加确定您的交易是成功的并且永远不会被更改。一旦一个区块被“最终确定”，它就只能通过网络级攻击来改变，而这将花费高昂代价。

值得注意的是，由于交易不签名会被伪造，因此每笔交易都需要私钥去签名，以太坊最初只有一种交易格式。每笔交易都包含随机数、gas 价格、gas limit、地址、值、数据、v、r 和 s。这些字段是RLP 编码的，看起来像这样：

RLP([nonce, gasPrice, gasLimit, to, value, data, v, r, s])

### 交易广播
节点在收到交易后，除了将交易缓存在交易池外，节点还会将交易广播至该节点已知的其他节点。
为了能让交易尽可能到达所有节点，其他收到广播过来的交易节点，也会根据一些精巧的策略选择一些节点，将交易再一次进行广播，比如：对于从其他节点转发过来的交易，节点只会随机选择25%的节点再次广播，因为这种情况一般意味着交易已经开始在网络中被节点接力传递，缩减广播的规模有助于避免因网络中冗余的交易太多而出现的广播风暴问题。

### 交易打包
为了提高交易处理效率，同时也为了确定交易之后的执行顺序保证事务性，当交易池中有交易时，**Sealer线程负责从交易池中按照先进先出的顺序取出一定数量的交易，组装成待共识区块，随后待共识区块会被发往各个节点进行处理。**

### 发起交易的所有流程
首先，我们发起一笔交易——tx。tx包含：
from、to、nonce、value、gas price（base fee+ priority fee）、Receipt（EOA还是Contract account）、Data、（v，r，s）：作为签名的依据。节点可能会收到数以千计的交易，并且区块以准恒定的速度（每几秒钟）被添加到区块链上，节点也可能从不同的用户和他们连接的其他节点处收到不同的交易。我们需要有某种缓冲区来存储所有这些传入的、尚未验证的交易......这就是内存池 **MemPool**发挥作用的地方，我将尝试从通用的角度来描述它是什么、如何工作以及它们可能有什么"副作用"。将已签署的交易广播给构成区块链网络的一个（或许多）节点。节点会收到你的交易，并在转发到网络中的其他节点之前检查其有效性和真实性（他们会检查发送者是否有足够的资金，更重要的是检查签名是否正确）。检查完交易后，**节点将把它添加到他们的内存池中**。在区块被添加到网络后，节点将重新检查他们内存池里所有的交易，因为区块里可能包含使内存池中一些交易无效的交易。mempool基本上是节点的**RAM内存**，它们在其中保存所有 "迄今为止 "已验证的交易，这是已经收到但还不能添加到区块链中的交易。
值得注意的是，由于其去中心化的性质，节点的内存池在任何时候都可能是不同的，它们可能持有不同的交易。同样重要的（也需要注意），你的交易也可能在任何时间点存在于多个节点的内存池。

一旦一个交易最终被矿工从其内存池中挑选出来并添加到一个区块中，所有其他在其内存池中包含相同交易的节点将着手删除它，因为同一交易不能被两次添加到区块链中。
### 如何取消交易
我们的Prague暂时不具备取消交易的能力。
在以太坊中，节点是不被信任的代理人，从这个意义上说，他们将永远从自己的最佳利益出发，就像之前已经描述的那样，他们会首先挑选那些支付最多费用的交易，这实际上是一种我们可以利用的行为，基于此，它将给我们提供在需要时取消交易的可能性（当然，尚未被添加到区块链的交易！）。
为了取消以前的交易，我们需要从同一个账户向网络提交一个新的交易，**使用相同的nonce，但费用（gas price）更高**。
节点会收到你的新交易，由于它支付的费用比之前的交易高，他们会先把它添加到区块链上。一个特定的账户其交易nonce只能使用一次，这意味着当他们把新的交易添加到区块链上时，旧的交易就会变得无效，并从内存池中删除。

















参考资料：  
[交易全流程](https://fisco-bcos-documentation.readthedocs.io/zh_CN/stable/docs/design/tx_procedure.html)  
[交易内存池如何工作](https://learnblockchain.cn/article/4496)  
[执行层和公式层的细节](https://ethereum.org/en/developers/docs/networking-layer/#execution-layer)  







